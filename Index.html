<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Creación de SDA v3</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --light-gray: #e9ecef;
            --white: #fff;
            --success-color: #28a745;
            --border-radius: 8px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            list-style: none;
            padding: 0;
        }
        .progress-bar li {
            flex: 1;
            text-align: center;
            color: var(--secondary-color);
            position: relative;
        }
        .progress-bar li.active {
            color: var(--primary-color);
            font-weight: bold;
        }
        .progress-bar li:not(:last-child)::after {
            content: '';
            position: absolute;
            width: calc(100% - 2rem);
            height: 2px;
            background-color: var(--light-gray);
            top: 50%;
            left: calc(50% + 1rem);
            transform: translateY(-50%);
        }
        .progress-bar li.active:not(:last-child)::after {
            background-color: var(--primary-color);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group small {
            color: var(--secondary-color);
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }
        .btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--white);
        }
        .btn-success {
            background-color: var(--success-color);
            color: var(--white);
            font-size: 1.2rem;
        }
        .radio-option {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
        }
        .radio-option:hover {
            border-color: var(--primary-color);
        }
        .radio-option label {
            display: block;
            font-weight: bold;
        }
        .radio-option small {
            color: var(--text-color);
        }
        #custom-product-area {
            display: none; /* Hidden by default */
            margin-top: 1rem;
        }
        
        /* Result Page Styles */
        #result-page h3, #result-page h4 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        #result-page h4 {
            border-bottom: none;
            margin-top: 1.5rem;
        }
        #result-page .action-bar {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }
        #result-page .action-bar .btn { margin: 0 0.5rem; }
        #result-page p, #result-page ul { line-height: 1.6; }
        #result-page ul { padding-left: 20px; }
        #result-page strong { color: var(--text-color); }
        #result-page table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #result-page th, #result-page td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: left;
        }
        #result-page th {
            background-color: var(--light-gray);
        }
        #result-page .presentation-btn {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            margin-left: 1rem;
            vertical-align: middle;
        }
        .loader {
            text-align: center;
        }
        .loader p {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .spinner {
            border: 8px solid var(--light-gray);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="container">
        <div id="wizard-container">
            <h1>Asistente de Creación de SDA</h1>
            
            <ul class="progress-bar">
                <li id="progress-1" class="active">Paso 1</li>
                <li id="progress-2">Paso 2</li>
                <li id="progress-3">Paso 3</li>
                <li id="progress-4">Paso 4</li>
            </ul>

            <!-- Step 1: Identification -->
            <div id="step-1" class="step active">
                <h2>Paso 1 de 4: ¿Qué vamos a planificar?</h2>
                <div class="form-group">
                    <label for="title">Título provisional de la SDA</label>
                    <input type="text" id="title" value="Las estructuras de mi ciudad">
                </div>
                <div class="form-group">
                    <label for="course">Curso</label>
                    <select id="course">
                        <option>1º ESO</option>
                        <option>2º ESO</option>
                        <option selected>3º ESO</option>
                        <option>4º ESO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subject">Materia</label>
                    <select id="subject">
                        <option selected>Tecnología y Digitalización</option>
                    </select>
                </div>
                <div class="navigation-buttons">
                    <span></span>
                    <button class="btn btn-primary" onclick="goToStep(2)">Siguiente &gt;</button>
                </div>
            </div>

            <!-- Step 2: Curriculum -->
            <div id="step-2" class="step">
                <h2>Paso 2 de 4: Selecciona los elementos curriculares</h2>
                <div>
                    <h3>Competencias Específicas</h3>
                    <div id="competencies-list">
                        <label><input type="checkbox" value="CE3" checked> CE3. Aplicar de forma apropiada...</label><br>
                        <label><input type="checkbox" value="CE5" checked> CE5. Hacer un uso responsable...</label>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <h3>Saberes Básicos</h3>
                    <div id="saberes-list">
                        <label><input type="checkbox" value="Estructuras" checked> Estructuras: Elementos resistentes...</label><br>
                        <label><input type="checkbox" value="Materiales" checked> Materiales de uso técnico...</label>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">&lt; Anterior</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">Siguiente &gt;</button>
                </div>
            </div>

            <!-- Step 3: Pedagogy -->
            <div id="step-3" class="step">
                <h2>Paso 3 de 4: ¿Cómo vamos a enseñar?</h2>
                <div class="form-group">
                    <label for="methodology">Metodología Principal</label>
                    <select id="methodology">
                        <option selected>Aprendizaje Basado en Proyectos (ABP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="resources">Herramientas y Recursos</label>
                    <textarea id="resources">Ordenadores, Móviles/Tablets, Material para maquetas.</textarea>
                </div>
                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">&lt; Anterior</button>
                    <button class="btn btn-primary" onclick="goToStep(4)">Siguiente &gt;</button>
                </div>
            </div>
            
            <!-- Step 4: Context -->
            <div id="step-4" class="step">
                <h2>Paso 4 de 4: El reto para tu alumnado</h2>
                <div class="form-group">
                    <label for="context">Descripción del Contexto</label>
                    <textarea id="context">Grupo participativo, entorno urbano...</textarea>
                </div>
                <div class="form-group">
                    <label for="final-product">Producto Final o Reto Principal</label>
                    <input type="text" id="final-product" value="Guía Interactiva de las Estructuras Notables de nuestra Ciudad">
                </div>
                <div class="form-group">
                    <label for="sessions">Número de Sesiones</label>
                    <input type="number" id="sessions" value="8">
                </div>
                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(3)">&lt; Anterior</button>
                    <button id="generate-btn" class="btn btn-success" onclick="generateSDA()">✨ ¡Generar Situación de Aprendizaje!</button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-view" class="step loader">
            <p>La IA está diseñando tu SDA...</p>
            <div class="spinner"></div>
            <p>Este proceso puede tardar unos segundos.</p>
        </div>

        <!-- Result Page -->
        <div id="result-page" class="step">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </div>

    <script>
        let currentStep = 1;

        function goToStep(stepNumber) {
            document.getElementById('step-' + currentStep).classList.remove('active');
            document.getElementById('progress-' + currentStep).classList.remove('active');

            currentStep = stepNumber;
            document.getElementById('step-' + currentStep).classList.add('active');
            
            for(let i = 1; i <= 4; i++) {
                const progressElement = document.getElementById('progress-' + i);
                if(progressElement) {
                    if(i <= currentStep) {
                        progressElement.classList.add('active');
                    } else {
                        progressElement.classList.remove('active');
                    }
                }
            }
        }

        async function generateSDA() {
            // 1. Show loading spinner and disable button
            document.getElementById('wizard-container').style.display = 'none';
            document.getElementById('loading-view').classList.add('active');
            
            // 2. Gather all data from the form
            const sdaData = {
                title: document.getElementById('title').value,
                course: document.getElementById('course').value,
                subject: document.getElementById('subject').value,
                competencies: Array.from(document.querySelectorAll('#competencies-list input:checked')).map(el => el.value),
                saberes: Array.from(document.querySelectorAll('#saberes-list input:checked')).map(el => el.value),
                methodology: document.getElementById('methodology').value,
                product: document.getElementById('final-product').value,
                contextDesc: document.getElementById('context').value,
                sessions: document.getElementById('sessions').value
            };

            try {
                // 3. Call our Netlify Function
                const response = await fetch('/.netlify/functions/generate-sda', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sdaData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // 4. Build the result HTML and display it
                buildResultPage(result);

            } catch (error) {
                console.error("Error calling Netlify function:", error);
                document.getElementById('result-page').innerHTML = `
                    <h2>Error en la Generación</h2>
                    <p>Lo sentimos, ha ocurrido un error al contactar con la IA. Por favor, inténtalo de nuevo más tarde.</p>
                    <p><i>Detalles del error: ${error.message}</i></p>
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" onclick="restart()">&lt; Empezar de Nuevo</button>
                    </div>`;
            } finally {
                // 5. Hide loading and show result
                document.getElementById('loading-view').classList.remove('active');
                document.getElementById('result-page').classList.add('active');
            }
        }
        
        function buildResultPage(data) {
            const resultContainer = document.getElementById('result-page');

            // Helper to build lists
            const buildList = (items) => `<ul>${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
            
            // Helper to build rubric
            const buildRubric = (rubricItems) => {
                let table = `<table><thead><tr><th>Criterio</th><th>Iniciado (1-4)</th><th>En Proceso (5-6)</th><th>Conseguido (7-8)</th><th>Experto (9-10)</th></tr></thead><tbody>`;
                rubricItems.forEach(item => {
                    table += `<tr><td><strong>${item.criteria}</strong></td>${item.levels.map(level => `<td>${level}</td>`).join('')}</tr>`;
                });
                table += `</tbody></table>`;
                return table;
            };

            resultContainer.innerHTML = `
                <div class="action-bar">
                    <button class="btn btn-primary">⬇️ Descargar PDF</button>
                    <button class="btn btn-secondary">✏️ Editar</button>
                </div>
                <h2>${data.title}</h2>
                <h3>1. Justificación y Contextualización</h3>
                <p>${data.justification}</p>
                
                <h3>2. Conexión Curricular</h3>
                <h4>Competencias Específicas</h4>
                ${buildList(data.curricularConnection.competencies)}
                <h4>Criterios de Evaluación</h4>
                ${buildList(data.curricularConnection.criteria)}
                <h4>Saberes Básicos</h4>
                ${buildList(data.curricularConnection.saberes)}
                
                <h3>3. Producto Final y Desafío</h3>
                <p>${data.finalProduct}</p>
                
                <h3>5. Secuencia de Actividades</h3>
                ${data.activities.map(act => `<p><strong>${act.title}</strong> <button class="btn btn-primary presentation-btn">🖥️ Generar Presentación</button><br>${act.description}</p>`).join('')}
                
                <h3>7. Escenario de Evaluación</h3>
                <h4>Rúbrica de Evaluación del Proyecto</h4>
                ${buildRubric(data.rubric)}
                
                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="restart()">&lt; Empezar de Nuevo</button>
                </div>
            `;
        }

        function restart() {
            window.location.reload();
        }
    </script>
</body>
</html>
